<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .pending { border-left: 4px solid #ff9800; }
        button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #357abd; }
        pre {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Django API</h1>
    
    <div class="test pending" id="status">
        <h3>–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
        <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</p>
    </div>

    <button onclick="testConnection()">üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
    <button onclick="testLogin()">üîë –¢–µ—Å—Ç –≤—Ö–æ–¥–∞</button>
    <button onclick="testRegister()">üìù –¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</button>

    <div id="results"></div>

    <script>
        const API_URL = 'http://localhost:8000/api/v1';

        function showResult(testName, success, data) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test ${success ? 'success' : 'error'}`;
            div.innerHTML = `
                <h4>${testName} ${success ? '‚úÖ' : '‚ùå'}</h4>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        function updateStatus(connected) {
            const status = document.getElementById('status');
            status.className = `test ${connected ? 'success' : 'error'}`;
            status.innerHTML = `
                <h3>${connected ? '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'}</h3>
                <p>Django API: ${connected ? '–î–æ—Å—Ç—É–ø–µ–Ω' : '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}</p>
            `;
        }

        async function testConnection() {
            try {
                const response = await fetch(`${API_URL}/auth/me/`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                // 401 —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - –∑–Ω–∞—á–∏—Ç —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞
                if (response.status === 401) {
                    updateStatus(true);
                    showResult('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API', true, {
                        status: 'OK',
                        message: 'Django API –¥–æ—Å—Ç—É–ø–µ–Ω (401 - –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)'
                    });
                } else {
                    const data = await response.json();
                    updateStatus(true);
                    showResult('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API', true, data);
                }
            } catch (error) {
                updateStatus(false);
                showResult('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API', false, error.message);
            }
        }

        async function testLogin() {
            try {
                const response = await fetch(`${API_URL}/auth/login/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'admin@admin.com',
                        password: 'admin123'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    updateStatus(true);
                    showResult('–í—Ö–æ–¥ (admin@admin.com)', true, {
                        access_token: data.access_token ? '***' : '–ù–µ –ø–æ–ª—É—á–µ–Ω',
                        user: data.user
                    });
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —Ç–µ—Å—Ç–æ–≤
                    localStorage.setItem('access_token', data.access_token);
                } else {
                    showResult('–í—Ö–æ–¥', false, data);
                }
            } catch (error) {
                showResult('–í—Ö–æ–¥', false, error.message);
            }
        }

        async function testRegister() {
            const email = `test_${Date.now()}@example.com`;
            try {
                const response = await fetch(`${API_URL}/auth/register/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: 'testpass123',
                        password_confirm: 'testpass123',
                        username: email.split('@')[0]
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    updateStatus(true);
                    showResult('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', true, data);
                    localStorage.setItem('access_token', data.access_token);
                } else {
                    showResult('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', false, data);
                }
            } catch (error) {
                showResult('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', false, error.message);
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = () => {
            console.log('API_URL:', API_URL);
            testConnection();
        };
    </script>
</body>
</html>
